# macOS LaunchAgent Service Configuration

This directory contains LaunchAgent property list (`.plist`) files for running Experimance services on macOS using Apple's native service management system.

## Overview

**LaunchAgents** are macOS's user-level service management system (part of launchd). They manage:
- Service startup and shutdown as the current user
- Automatic restart on failure
- Environment variables
- Logging
- No root privileges required

**Important**: We use LaunchAgents (user-level) exclusively, never LaunchDaemons (system-level), for better security and integration with user environments.

## Architecture

- **LaunchAgents** run as the logged-in user (`~/Library/LaunchAgents/`)
- **Direct uv execution** - no wrapper scripts needed
- **Full Disk Access** for uv binary enables proper permissions
- **Auto-login** recommended for reliable startup

## Files

Generated by deploy script:
- `com.experimance.fire.agent.plist` - Fire Agent service  
- `com.experimance.fire.health.plist` - Health monitoring service

Templates (if creating manually):
- `com.experimance.agent.template.plist` - Template for agent services
- `com.experimance.health.template.plist` - Template for health services

**Note**: Use the deploy script (`./infra/scripts/deploy.sh`) instead of manual installation.

## Installation

### 1. Prerequisites

- **macOS 12.0+** (Monterey or later)
- **Homebrew** installed with `uv` package manager: `brew install uv`
- **Auto-login enabled** for the user account (System Settings → Users & Groups → Login Options)
- **Experimance project** cloned to user directory
- **Project configuration** set up in `projects/fire/.env`

### 2. Install Services (Recommended Method)

Use the deploy script for automatic installation:

```bash
# Install LaunchAgent plist files
./infra/scripts/deploy.sh fire install

# Grant Full Disk Access (one-time setup)
# 1. Open System Settings → Privacy & Security → Full Disk Access
# 2. Click + to add applications
# 3. Navigate to /opt/homebrew/bin/uv (or path from `which uv`)
# 4. Toggle switch to grant access

# Start services
./infra/scripts/deploy.sh fire start

# Check status
./infra/scripts/deploy.sh fire status
```

### 3. Manual Installation (Advanced)

If you need to install manually without the deploy script:

```bash
# Create LaunchAgent directory
mkdir -p ~/Library/LaunchAgents

# Copy plist files (created by deploy script or manually)
cp infra/launchd/com.experimance.fire.*.plist ~/Library/LaunchAgents/

# Set permissions
chmod 644 ~/Library/LaunchAgents/com.experimance.fire.*.plist

# Load services
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.experimance.fire.agent.plist
launchctl bootstrap gui/$(id -u) ~/Library/LaunchAgents/com.experimance.fire.health.plist
```

## Service Management

### Using Deploy Script (Recommended)

```bash
# Start services
./infra/scripts/deploy.sh fire start

# Stop services  
./infra/scripts/deploy.sh fire stop

# Restart services
./infra/scripts/deploy.sh fire restart

# Check status
./infra/scripts/deploy.sh fire status
```

### Manual LaunchAgent Commands

```bash
# Check service status
launchctl list | grep experimance

# Check specific service
launchctl print gui/$(id -u)/com.experimance.agent.fire

# Start/stop services manually
launchctl kickstart gui/$(id -u)/com.experimance.agent.fire
launchctl kill TERM gui/$(id -u)/com.experimance.agent.fire

# Unload services
launchctl bootout gui/$(id -u) ~/Library/LaunchAgents/com.experimance.fire.agent.plist
launchctl bootout gui/$(id -u) ~/Library/LaunchAgents/com.experimance.fire.health.plist
```

## Logs

LaunchAgent logs are written to the standard macOS user log directory:
- `~/Library/Logs/experimance/fire_agent_launchd.log` - Agent service stdout
- `~/Library/Logs/experimance/fire_agent_launchd_error.log` - Agent service stderr  
- `~/Library/Logs/experimance/fire_health_launchd.log` - Health service stdout
- `~/Library/Logs/experimance/fire_health_launchd_error.log` - Health service stderr

View logs in real-time:
```bash
# Follow agent logs
tail -f ~/Library/Logs/experimance/fire_agent_launchd_error.log

# Follow health logs  
tail -f ~/Library/Logs/experimance/fire_health_launchd_error.log

# List all LaunchAgent logs
ls -la ~/Library/Logs/experimance/*launchd*.log
```

## Configuration Details

### Key Properties Explained

- **Label**: Unique identifier for the service (e.g., `com.experimance.agent.fire`)
- **ProgramArguments**: Direct call to uv: `["/opt/homebrew/bin/uv", "run", "-m", "fire_agent"]`
- **WorkingDirectory**: Project directory where services run
- **EnvironmentVariables**: `PROJECT_ENV=fire` to specify project
- **RunAtLoad**: Start service when loaded (at login)
- **KeepAlive**: Restart policy (restart on unexpected exit)
- **ThrottleInterval**: Wait time before restart attempts (10 seconds)
- **StandardOutPath/StandardErrorPath**: Log file locations in project `logs/` directory

### Direct uv Execution

Services now call uv directly without wrapper scripts:
```xml
<key>ProgramArguments</key>
<array>
    <string>/opt/homebrew/bin/uv</string>
    <string>run</string>
    <string>-m</string>
    <string>fire_agent</string>
</array>
```

This requires uv to have Full Disk Access permission.

## Troubleshooting

### Service Won't Start
1. **Check plist syntax**: `plutil ~/Library/LaunchAgents/com.experimance.fire.agent.plist`
2. **Verify Full Disk Access**: System Settings → Privacy & Security → Full Disk Access → ensure uv is listed
3. **Check uv path**: `which uv` should show `/opt/homebrew/bin/uv`
4. **Test manual execution**: `PROJECT_ENV=fire uv run -m fire_agent`

### Service Crashes/Restarts
1. **Check error logs**: `tail -f logs/fire_agent_launchd_error.log`
2. **Verify project configuration**: `cat projects/fire/.env`
3. **Check module name**: Use `fire_agent` not `experimance_agent` for fire project
4. **Hardware dependencies**: Agent may fail if Reolink camera not available (expected behavior)

### Permission Issues
1. **Grant Full Disk Access to uv**: Required for LaunchAgent execution
2. **Check log directory**: `ls -la logs/` should be writable by current user
3. **Auto-login recommended**: System Settings → Users & Groups → Login Options

### "Operation not permitted" Errors
- **Root cause**: macOS TCC (Transparency, Consent, and Control) framework blocking execution
- **Solution**: Grant Full Disk Access to `/opt/homebrew/bin/uv` in System Settings

## Differences from systemd

| Feature          | systemd                    | macOS LaunchAgents              |
| ---------------- | -------------------------- | ------------------------------- |
| Config format    | INI-style `.service` files | XML `.plist` files              |
| Location         | `/etc/systemd/system/`     | `~/Library/LaunchAgents/`       |
| Commands         | `systemctl`                | `launchctl`                     |
| User privileges  | Requires `sudo`            | Runs as current user            |
| Dependencies     | `After=`, `Wants=`         | Limited dependency support      |
| Restart policy   | `Restart=`                 | `KeepAlive` dict                |
| Environment      | `Environment=`             | `EnvironmentVariables` dict     |
| Execution method | Direct binary/script       | Direct uv execution             |

## Integration with Multi-Machine Deployment

These LaunchAgent services integrate with the multi-machine deployment system. In a typical fire project setup:

**macOS Machine** (LaunchAgents):
- `fire_agent` - AI interaction service with audio/video processing
- `experimance_health` - Health monitoring service

**Ubuntu Machine** (systemd):
- `core` - Core state management service  
- `display` - Visual display service
- `image_server` - Image generation service
- `experimance_health` - Health monitoring service

The deployment script (`./infra/scripts/deploy.sh`) automatically detects the platform and uses the appropriate service management system.
