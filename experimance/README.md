# Experimance

Interactive sand-table art installation with AI-generated satellite imagery.

Projected on to a 


## Overview

This project consists of multiple services that communicate via ZeroMQ:
- Core service (`experimance_core`) - Central orchestration service
- Display service (`experimance_display`) - Handles visualization on the sand table
- Image generation service (`image_server`) - Creates AI-generated satellite imagery
- Transition service (`experimance_transition`) - Handles smooth transitions between images
- Audio service (`experimance_audio`) - Provides audio feedback and soundscapes
- Agent service (`experimance_agent`) - AI agents that interact with the installation

## Project Structure

The project uses a modern Python package structure with src layout:

```
experimance/
├── libs/
│   └── common/          # Shared common libraries
│       └── src/
│           └── experimance_common/
│               ├── zmq/
│               │   ├── config.py           # ZMQ configuration pydantic models
│               │   ├── components.py       # ZMQ communication components
│               │   ├── services.py         # ZMQ services composed of components
│               │   └── mocks.py            # Mock ZMQ components for testing
│               ├── config.py               # Service configuration management using pydantic
│               ├── constants.py            # Constants used across the project
│               ├── logger.py               # Logging utilities
│               ├── schemas.py              # Pydantic schemas for data validation across services
│               ├── schemas.pyi             # Type stubs for schemas, supporting multiple projects
│               └── image_utils.py          # Image processing utilities
├── services/
│   ├── core/            # Core service managing state machine
│   │   └── src/
│   │       └── experimance_core/
│   │
│   ├── display/         # Display service for sand table visualization
│   │   └── src/
│   │       └── experimance_display/
│   │
│   ├── audio/           # Audio service for sound generation
│   │   └── src/
│   │       └── experimance_audio/
│   │
│   ├── agent/           # Agent service for AI interaction
│   │   └── src/
│   │       └── experimance_agent/
│   │
│   ├── image_server/    # Image generation service
│       └── src/
│           └── image_server/
│
├── utils/               # Utility modules for testing and other purposes
│   ├── examples/        # Examples of usage
│   └── tests/           # Testing utilities for cross service testing
├── scripts/             # Utility scripts for setup and management
├─ infra/
│
├── pyproject.toml       # Main project configuration file
│
└── projects/                 # **ONLY project-specific artifacts live here**
│   ├─ experimance/
│   │   ├─ .env             # Experimance project environment variables
│   │   ├─ config.toml      # Experimance project configuration
│   │   ├─ constants.py     # constants specific to Experimance project
│   │   ├─ schemas.py       # schemas specific to Experimance project
│   │   └─ schemas.pyi      # type stubs for schemas
│   └─ sohkepayin/          # overrides for Sohkepayin project
│       └─ ...              # configuration files for Sohkepayin project  
│
└── media/
    ├── images/                # images used by the software
    │   └── mocks/             # mock images used for testing
    |   └── generated/         # images generated by the software
    └── videos/                # videos used by the software
        └── generated/         # videos generated by the software
```

## Installation

We use [uv](https://github.com/astral-sh/uv) as our package manager for faster, more reliable dependency management. Make sure it's installed before proceeding:

```bash
curl -sSf https://astral.sh/uv/install.sh | sh
```

### Quick Install

```bash
./setup.sh
```

This will:
1. Create a Python virtual environment using uv
2. Install all required dependencies
3. Install all services in development mode

### Manual Installation

If you prefer to install manually:

```bash
# System dependencies (Ubuntu/Debian)
sudo apt-get install libssl-dev libusb-1.0-0-dev libsdl2-dev ffmpeg libasound2-dev portaudio19-dev

# Create and activate virtual environment
uv sync
```

## Running Services

Each service can be run independently:

# TODO:
```bash
uv run experimance
```

Or run services separately:
```bash
uv run python -m experimance_[service_name] --arg
```

## Development

Each service is a complete Python package with its own:
- Dependencies in pyproject.toml
- Source code in src/package_name/
- Tests in its own tests/ directory

This structure makes development cleaner by:
- Avoiding complex import hacks
- Supporting proper editable installs
- Making packages independently testable


## Multi-Project Architecture

This codebase supports multiple art installation projects through a **dynamic loading system**:

### How It Works
- **Base schemas/constants** in `libs/common/src/experimance_common/*_base.py` define shared functionality
- **Project-specific extensions** in `projects/{project_name}/` override or extend base definitions
- **Dynamic loading** at runtime merges base + project-specific definitions based on `PROJECT_ENV`

### Project Selection
- Set `PROJECT_ENV=experimance` or `PROJECT_ENV=projectname` to switch projects
- Each project can have different enums and message extensions

### Adding New Projects
1. Create `projects/{new_project}/` directory
2. Add project-specific `.env`, `schemas.py`, `constants.py` files
3. In `schemas.py`, extend base classes: e.g. `class RenderRequest(_BaseRenderRequest):`
4. Define project-specific enums
5. Update mypy_path in `pyproject.toml` to include the new project directory

### Schema Extension Pattern
```python
# In projects/{project}/schemas.py
from experimance_common.schemas_base import RenderRequest as _BaseRenderRequest

class RenderRequest(_BaseRenderRequest):
    era: Era              # Project-specific Era enum
    biome: Biome          # Project-specific Biome enum  
    # Add project-specific fields here
```

### Benefits
- **Shared Infrastructure**: All projects use the same ZMQ communication, base services, and utilities
- **Type Safety**: Each project gets proper type checking for its specific Era/Biome values
- **Clean Separation**: Project-specific logic is isolated in `projects/` directory
- **Easy Switching**: Change `PROJECT_ENV` to work on different projects
- **Extensible**: New projects can add custom message types or extend existing ones

### Usage Examples
```bash
# Work on Experimance project
PROJECT_ENV=experimance uv run -m experimance_core

# Work on Sohkepayin project  
PROJECT_ENV=sohkepayin uv run -m experimance_core

# Import project-specific schemas
from experimance_common.schemas import Era, Biome  # Loaded based on PROJECT_ENV
```



### Install tools

```bash
uv tool install ruff
uv tool install pytest
uv add --dev pytest pytest-asyncio pytest-mock pytest-cov 
```

## Package management

Use `uv` and see: https://docs.astral.sh/uv/concepts/projects/workspaces/ for reference.

To update all packages to latest versions:
```
uv sync
```

To update a particular service (e.g. core):
```
uv sync --package experimance-core
```

To update a particular dependency:
```
uv lock --upgrade-package opencv-python
```

### Troubleshooting packages

If you encounter issues with installation or imports, we provide several testing utilities:

```bash
# Basic import test
uv run python utils/tests/simple_test.py

# Check environment setup
uv run python utils/tests/check_env.py
```

See `utils/tests/README.md` for detailed information about these utilities and common troubleshooting steps.


## Testing

Run tests with uv and pytest:

```bash
# Install development dependencies
uv sync --only-dev

# Run all tests
uv run -m pytest

# Run tests with coverage
uv run -m pytest --cov=experimance_common

# Run specific tests
uv run -m pytest -v utils/tests/test_zmq_utils.py -k test_name

# Run tests in a specific service
uv run -m pytest services/audio/tests

# Run tests with specific markers or names
uv run -m pytest -k "ImageServer"

```

See [`utils/tests/README.md`](utils/tests/README.md) and [`utils/tests/README_ZMQ_TESTS.md](utils/tests/README_ZMQ_TESTS.md) for more details.

