# Experimance

Interactive installation with audience presence detection and other interaction that drives AI-generated visuals and sounds, with dynamic music playback.


## Overview

This project consists of multiple services that communicate via ZeroMQ:
- Core service (`experimance_core`) - Central orchestration service
- Display service (`experimance_display`) - Handles visualization on the sand table
- Image generation service (`image_server`) - Creates AI-generated satellite imagery
- Transition service (`experimance_transition`) - Handles smooth transitions between images
- Audio service (`experimance_audio`) - Provides audio feedback and soundscapes
- Agent service (`experimance_agent`) - AI agents with vision capabilities that interact with the installation

## Project Structure

The project uses a modern Python package structure with src layout:

```
experimance/
├── libs/
│   └── common/          # Shared common libraries
│       └── src/
│           └── experimance_common/
│               ├── zmq/
│               │   ├── config.py           # ZMQ configuration pydantic models
│               │   ├── components.py       # ZMQ communication components
│               │   ├── services.py         # ZMQ services composed of components
│               │   └── mocks.py            # Mock ZMQ components for testing
│               ├── config.py               # Service configuration management using pydantic
│               ├── constants.py            # Constants used across the project
│               ├── logger.py               # Logging utilities
│               ├── schemas.py              # Pydantic schemas for data validation across services
│               ├── schemas.pyi             # Type stubs for schemas, supporting multiple projects
│               └── image_utils.py          # Image processing utilities
├── services/
│   ├── core/            # Core service managing state machine
│   │   └── src/
│   │       └── experimance_core/
│   │
│   ├── display/         # Display service for sand table visualization
│   │   └── src/
│   │       └── experimance_display/
│   │
│   ├── audio/           # Audio service for sound generation
│   │   └── src/
│   │       └── experimance_audio/
│   │
│   ├── agent/           # Agent service for AI interaction
│   │   └── src/
│   │       └── experimance_agent/
│   │
│   ├── image_server/    # Image generation service
│       └── src/
│           └── image_server/
│
├── utils/               # Utility modules for testing and other purposes
│   ├── examples/        # Examples of usage
│   └── tests/           # Testing utilities for cross service testing
│
├── scripts/             # Utility scripts for setup and management (development)
│
├─ infra/                # Infrastructure related files
│   ├── scripts/         # Scripts for installing and monitoring the project (production)
│   └── systemd/         # Systemd service files     
│
├── docs/                # Additional in-depth docs on various features
|
├── pyproject.toml       # Main project configuration file
│
└── projects/                 # **ONLY project-specific artifacts live here**
│   ├─ experimance/
│   │   ├─ .env             # Experimance project environment variables
│   │   ├─ config.toml      # Experimance project configuration
│   │   ├─ constants.py     # constants specific to Experimance project
│   │   ├─ schemas.py       # schemas specific to Experimance project
│   │   ├─ schemas.pyi      # type stubs for schemas
│   │   ├─ core.toml        # configuration for the core service
│   │   └─ <service>.toml   # configuration for the <service>
│   └─ fire/                # overrides for Feed the Fires project
│       └─ ...              # configuration files for Feed the Fires project  
│
└── media/
    ├── images/
    │   └── display/           # images used by the display service (these are in repo)
    │   └── mocks/             # mock images used for testing
    |   └── generated/         # images generated by the software
    └── videos/                # videos used by the software
        └── generated/         # videos generated by the software
```

## Installation

### Quick Install

```bash
./infra/scripts/deploy.sh install experimance dev
```

This will:
1. Install pyenv and install the correct Python version
2. Create a Python virtual environment using uv
3. Install all required dependencies
4. Install all services in development mode
5. Download needed files

See the [infrastructure README](infra/README.md) for more details.

### Manual Installation

If you prefer to install manually:

We use [uv](https://github.com/astral-sh/uv) as our package manager for faster, more reliable dependency management. Make sure it's installed before proceeding:

```bash
curl -sSf https://astral.sh/uv/install.sh | sh
```

```bash
# System dependencies (Ubuntu/Debian)
sudo apt-get install libssl-dev libusb-1.0-0-dev libsdl2-dev ffmpeg libasound2-dev portaudio19-dev

# Create and activate virtual environment
uv sync
```

# Services

Experimance is currently comprised of a number of services:

* ## Core
  * The main controller / coordinator
  * Custom to each project
  * [readme](services/core/README.md)
  * [depth camera readme](services/core/README_DEPTH.md)
* ## Image Server
  * Image and audio generation using multiple plugin generators
  * Receives `RenderRequest`s, replies with `ImageReady` or `AudioReady`
  * [readme](services/image_server/README.md)
* ## Agent
  * Voice agent powered by `pipecat` and `pipecat-flows`
  * Supports many flavours of TTS, STT and LLM
  * Integrated vision system to detect audience (CPU and VLM based)
  * [readme](services/agent/README.md)
  * Multi-channel audio support with delay compensation for echo cancellation
    * Useful for adding additional speakers for voice agent output for additional volume
    * [Multi-channel audio documentation](docs/multi_channel_audio.md)
* ## Display
  * Simple, `pyglet`-based display
  * Displays and transitions between images, displays video and text overlays
  * [readme](services/display/README.md)
* ## Transition
  * IN PROGRESS
  * Advanced video transition generation between images
  * Creates smooth, artistic transitions using gradient maps and posterization
  * Used by display service for image transitions
* ## Audio
  * Handles audio (effects, ambience and music)
  * [Supercollider](https://supercollider.github.io/) headless plays audio & music
  * [readme](services/audio/README.md)
* ## Health
  * Monitors health status of all other services
  * Detects stale or missing health data
  * Sends notifications via ntfy.sh when services become unhealthy
  * [readme](services/health/README.md)
  * [health system documentation](docs/health_system.md)


## Projects using Experimance

A couple of completed projects use this codebase.

### Experimance #5

[![Experimance video](https://img.youtube.com/vi/smPN-c-78cE/maxresdefault.jpg)](https://youtu.be/smPN-c-78cE)

- [Experimance by Ryan Kelln](https://www.ryankelln.com/project/experimance/)
  - The original installation: an interactive sand-table experience combining audience-presence detection, AI-generated satellite imagery, and generative soundscapes.
  - [Video documentation](https://youtu.be/smPN-c-78cE)

### Feed the Fires

[![Experimance video](https://img.youtube.com/vi/W0TVMIROnqc/maxresdefault.jpg)](https://youtu.be/W0TVMIROnqc)

- [Feed the Fires by Ryan Kelln, Kyle Duffield and Mike Dunn](https://www.ryankelln.com/project/feed-the-fires/)
  - A site-specific adaptation that focuses on community and environmental themes, using the same Experimance architecture to drive visuals and audio in response to participants stories told to a "fire spirit".
  - [Video documentation](https://youtu.be/W0TVMIROnqc)


## Running Services

### Development Script
Use the development script for coordinated service management with automatic cleanup:

```bash
# Start single service (foreground)
./scripts/dev health

# Start multiple services (background with logging)
./scripts/dev health core display

# Start all services
./scripts/dev all
```

The dev script automatically cleans up existing services before starting new ones.

### Direct Service Execution
For isolated testing, run services directly:

```bash
# Run individual services
uv run -m experimance_core
uv run -m experimance_display
uv run -m experimance_agent

# Override configuration with args:
uv run -m experimance_core --log-level=debug --help

# Override configuration with environment variables (less preferred):
EXPERIMANCE_ZMQ_BASE_PORT=6000 uv run -m experimance_core
EXPERIMANCE_CORE_LOG_LEVEL=DEBUG uv run -m experimance_core
```

Environment variables follow the pattern: `EXPERIMANCE_<SECTION>_<KEY>=value`

## Development

Each service is a complete Python package with its own:
- Dependencies in pyproject.toml
- Source code in src/package_name/
- Tests in its own tests/ directory

This structure makes development cleaner by:
- Avoiding complex import hacks
- Supporting proper editable installs
- Making packages independently testable

### Type Stub Automation

To keep type stubs (`schemas.pyi` and `constants.pyi`) up to date for static analysis and IDE support, edit the `.pyi` files or update the provided script and then run it:

```bash
uv run python scripts/update_pyi_stubs.py --diff   # Show diffs and confirm before overwriting
uv run python scripts/update_pyi_stubs.py --dry-run # Preview generated files only
uv run python scripts/update_pyi_stubs.py           # Update files directly
```

This script automatically generates and updates the stub files based on the current base and project-specific schemas/constants. Use the `--diff` or `--dry-run` options for safety before overwriting.

## CLI Tools

The project includes several command-line utilities installed as console scripts:

- **set-project** - Switch between installation projects (experimance, fire, etc.)
- **transcripts** - View and follow agent conversation transcripts
- **timeline** - Unified view of transcripts and prompts by timestamp, with distributed deployment support
- **vastai** - Manage remote GPU instances for image generation

All tools support `--help` for detailed usage:
```bash
uv run transcripts --help
uv run timeline --help
uv run vastai --help
```

**Quick Examples:**
```bash
# Switch projects (also: scripts/project fire)
uv run set-project fire

# Follow latest transcript
uv run transcripts follow

# Stream unified timeline
uv run timeline stream

# Manage GPU instances
uv run vastai list
uv run vastai provision
```

See [DISTRIBUTED_TIMELINE_GUIDE.md](DISTRIBUTED_TIMELINE_GUIDE.md) for distributed deployment features.

## Multi-Project Architecture

This codebase supports multiple art installation projects through a **dynamic loading system**:

### How It Works
- **Base schemas/constants** in `libs/common/src/experimance_common/*_base.py` define shared functionality
- **Project-specific extensions** in `projects/{project_name}/` override or extend base definitions
- **Automatic project detection** loads the correct project based on `projects/.project` file or environment variables

### Project Selection

**Simple Method (Recommended):**
```bash
# Set current project
scripts/project fire

# Check current project  
scripts/project

# Switch back to experimance
scripts/project experimance
```

See the [CLI Tools](#cli-tools) section for more details on the `set-project` command.

**Environment Override (when needed):**
```bash
# Override for current session
export PROJECT_ENV=fire

# Override for single command
PROJECT_ENV=experimance uv run -m experimance_core
```

**How Detection Works:**
1. **Environment Variable**: `PROJECT_ENV` (highest priority)
2. **Project File**: `projects/.project` file content
3. **Default**: "experimance" (fallback)

Once set, all services automatically use the selected project configuration.


## Creating a New Project

You can create a new project either manually or using the interactive setup script:

### Option 1: Manual Creation

1. **Create the project directory:**
   - Add a new folder under `projects/{new_project}/`
2. **Add project-specific files:**
   - `.env` for environment variables
   - `config.toml` for project-wide configuration
   - `constants.py` for project-specific constants
   - `schemas.py` for project-specific schemas (extend base classes as needed)
   - `schemas.pyi` for type stubs
   - `<service>.toml` for each service config (e.g., `core.toml`, `display.toml`)
3. **Extend base schemas and enums:**
   - In `schemas.py`, extend base classes (see [libs/common/README_SERVICE.md](libs/common/README_SERVICE.md) for examples)
   - Define project-specific enums and message types
4. **Update static analysis paths:**
   - Add your project directory to `mypy_path` in `pyproject.toml` for type checking
5. **Test your project:**
   - Run `scripts/project {new_project}` to set the active project
   - Run services to verify correct loading: `uv run -m experimance_core`

### Option 2: Using the Interactive Script

Use the provided script to automate project setup:

```bash
uv run python scripts/create_new_project.py
```

This script will:
- Prompt for project name and services
- Copy config templates from existing projects or service defaults
- Generate all necessary files and directories
- Ensure proper structure for multi-project support

**Features:**
- Supports copying configs from other projects or service defaults
- Generates TOML config, Python templates, and type stubs
- Interactive prompts for customization

See [scripts/README.md](scripts/README.md) for usage details and options.

---

### Schema Extension Pattern
```python
# In projects/{project}/schemas.py
from experimance_common.schemas_base import RenderRequest as _BaseRenderRequest

class RenderRequest(_BaseRenderRequest):
    era: Era              # Project-specific Era enum
    biome: Biome          # Project-specific Biome enum  
    # Add project-specific fields here
```

### Benefits
- **Shared Infrastructure**: All projects use the same ZMQ communication, base services, and utilities
- **Type Safety**: Each project gets proper type checking for its specific Era/Biome values
- **Clean Separation**: Project-specific logic is isolated in `projects/` directory
- **Easy Switching**: Use `scripts/project {name}` to switch between projects
- **Extensible**: New projects can add custom message types or extend existing ones

### Usage Examples
```bash
# Set active project (persists across sessions)
scripts/project fire

# All services now use fire project automatically
uv run -m experimance_core

# Check current project
scripts/project

# Switch back to experimance
scripts/project experimance

# Override with environment variable (temporary)
PROJECT_ENV=fire uv run -m experimance_core

# Import project-specific schemas (loaded automatically)
from experimance_common.schemas import Era, Biome
```



### Install tools

```bash
uv tool install ruff
uv tool install pytest
uv add --dev pytest pytest-asyncio pytest-mock pytest-cov 
```

## Package management

Use `uv` and see: https://docs.astral.sh/uv/concepts/projects/workspaces/ for reference.

To update all packages to latest versions:
```
uv sync
```

To update a particular service (e.g. core):
```
uv sync --package experimance-core
```

To update a particular dependency:
```
uv lock --upgrade-package opencv-python
```

### Troubleshooting packages

If you encounter issues with installation or imports, we provide several testing utilities:

```bash
# Basic import test
uv run python utils/tests/simple_test.py

# Check environment setup
uv run python utils/tests/check_env.py
```

See `utils/tests/README.md` for detailed information about these utilities and common troubleshooting steps.


## Testing

Run tests with uv and pytest:

```bash
# Install development dependencies
uv sync --only-dev

# Run all tests
uv run -m pytest

# Run tests with coverage
uv run -m pytest --cov=experimance_common

# Run specific tests
uv run -m pytest -v utils/tests/test_zmq_utils.py -k test_name

# Run tests in a specific service
uv run -m pytest services/audio/tests

# Test agent service vision capabilities
cd services/agent && uv run python tests/test_vision_imports.py
cd services/agent && uv run python tests/test_cpu_detection.py

# Run tests with specific markers or names
uv run -m pytest -k "ImageServer"

```

See [`utils/tests/README.md`](utils/tests/README.md) and [`utils/tests/README_ZMQ_TESTS.md](utils/tests/README_ZMQ_TESTS.md) for more details.

## Advanced Features Documentation

For detailed documentation on advanced system features:

- **[Multi-GPU Configuration Guide](docs/multi_gpu_subprocess_guide.md)** - GPU isolation for concurrent image/audio generation with persistent subprocess workers and comprehensive metadata system
- **[Generator System Guide](services/image_server/src/image_server/generators/README_GENERATORS.md)** - Complete guide to image and audio generation systems, including TangoFlux audio generation with semantic caching
- **[Audio Cache Management](scripts/README_AUDIO_CACHE.md)** - Cache management tools for audio generation including statistics, cleanup, and maintenance
- **[Multi-Channel Audio System](docs/multi_channel_audio.md)** - Complete guide to the multi-channel audio transport with delay compensation for echo cancellation
- **[Multi-Channel Quick Reference](docs/multi_channel_quick_reference.md)** - Quick setup and configuration guide for multi-channel audio
- **[Health System](docs/health_system.md)** - Service monitoring and health management
- **[Image ZMQ Utilities](docs/image_zmq_utilities.md)** - Image processing and ZMQ integration
- **[Logging System](docs/logging_system.md)** - Centralized logging and debugging
- **[Transcript Display](docs/transcript_display_best_practices.md)** - Best practices for agent transcript display
