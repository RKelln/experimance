# Experimance

Interactive sand-table art installation with AI-generated satellite imagery.

Projected on to a 


## Overview

This project consists of multiple services that communicate via ZeroMQ:
- Core service (`experimance_core`) - Central orchestration service
- Display service (`experimance_display`) - Handles visualization on the sand table
- Image generation service (`image_server`) - Creates AI-generated satellite imagery
- Transition service (`experimance_transition`) - Handles smooth transitions between images
- Audio service (`experimance_audio`) - Provides audio feedback and soundscapes
- Agent service (`experimance_agent`) - AI agents with vision capabilities that interact with the installation

## Project Structure

The project uses a modern Python package structure with src layout:

```
experimance/
├── libs/
│   └── common/          # Shared common libraries
│       └── src/
│           └── experimance_common/
│               ├── zmq/
│               │   ├── config.py           # ZMQ configuration pydantic models
│               │   ├── components.py       # ZMQ communication components
│               │   ├── services.py         # ZMQ services composed of components
│               │   └── mocks.py            # Mock ZMQ components for testing
│               ├── config.py               # Service configuration management using pydantic
│               ├── constants.py            # Constants used across the project
│               ├── logger.py               # Logging utilities
│               ├── schemas.py              # Pydantic schemas for data validation across services
│               ├── schemas.pyi             # Type stubs for schemas, supporting multiple projects
│               └── image_utils.py          # Image processing utilities
├── services/
│   ├── core/            # Core service managing state machine
│   │   └── src/
│   │       └── experimance_core/
│   │
│   ├── display/         # Display service for sand table visualization
│   │   └── src/
│   │       └── experimance_display/
│   │
│   ├── audio/           # Audio service for sound generation
│   │   └── src/
│   │       └── experimance_audio/
│   │
│   ├── agent/           # Agent service for AI interaction
│   │   └── src/
│   │       └── experimance_agent/
│   │
│   ├── image_server/    # Image generation service
│       └── src/
│           └── image_server/
│
├── utils/               # Utility modules for testing and other purposes
│   ├── examples/        # Examples of usage
│   └── tests/           # Testing utilities for cross service testing
├── scripts/             # Utility scripts for setup and management
├─ infra/
│
├── pyproject.toml       # Main project configuration file
│
└── projects/                 # **ONLY project-specific artifacts live here**
│   ├─ experimance/
│   │   ├─ .env             # Experimance project environment variables
│   │   ├─ config.toml      # Experimance project configuration
│   │   ├─ constants.py     # constants specific to Experimance project
│   │   ├─ schemas.py       # schemas specific to Experimance project
│   │   ├─ schemas.pyi      # type stubs for schemas
│   │   ├─ core.toml        # configuration for the core service
│   │   └─ <service>.toml   # configuration for the <service>
│   └─ sohkepayin/          # overrides for Sohkepayin project
│       └─ ...              # configuration files for Sohkepayin project  
│
└── media/
    ├── images/
    │   └── display/           # images used by the display service (these are in repo)
    │   └── mocks/             # mock images used for testing
    |   └── generated/         # images generated by the software
    └── videos/                # videos used by the software
        └── generated/         # videos generated by the software
```

## Installation

### Quick Install

```bash
./infra/scripts/deploy.sh install experimance dev
```

This will:
1. Install pyenv and install the correct Python version
2. Create a Python virtual environment using uv
3. Install all required dependencies
4. Install all services in development mode
5. Download needed files

See the [infrastructure README](infra/README.md) for more details.

### Manual Installation

If you prefer to install manually:

We use [uv](https://github.com/astral-sh/uv) as our package manager for faster, more reliable dependency management. Make sure it's installed before proceeding:

```bash
curl -sSf https://astral.sh/uv/install.sh | sh
```

```bash
# System dependencies (Ubuntu/Debian)
sudo apt-get install libssl-dev libusb-1.0-0-dev libsdl2-dev ffmpeg libasound2-dev portaudio19-dev

# Create and activate virtual environment
uv sync
```

#### Video Overlay Manual Download

If the automated download fails during deployment, you can manually download the video overlay:

```bash
mkdir -p media/video
wget --quiet --no-check-certificate \
    "https://docs.google.com/uc?export=download&id=144JbBnjyz-GmB5RJdmafDagDRurXfB2L" \
    -O media/video/experimance_video_overlay.mp4
```

### Vision System Setup

The agent service includes vision capabilities for audience detection. To set up and test webcam functionality:

```bash
# Check available webcams
uv run python scripts/list_webcams.py

# Test vision system components
cd services/agent && uv run python tests/test_vision_imports.py

# Test CPU-based audience detection
cd services/agent && uv run python tests/test_cpu_detection.py
```

## Running Services

### Development Script
Use the development script for coordinated service management with automatic cleanup:

```bash
# Start single service (foreground)
./scripts/dev health

# Start multiple services (background with logging)
./scripts/dev health core display

# Start all services
./scripts/dev all
```

The dev script automatically cleans up existing services before starting new ones.

### Direct Service Execution
For isolated testing, run services directly:

```bash
# Run individual services
uv run -m experimance_core
uv run -m experimance_display
uv run -m experimance_agent

# Override configuration with args:
uv run -m experimance_core --log-level=debug --help

# Override configuration with environment variables (less preferred):
EXPERIMANCE_ZMQ_BASE_PORT=6000 uv run -m experimance_core
EXPERIMANCE_CORE_LOG_LEVEL=DEBUG uv run -m experimance_core
```

Environment variables follow the pattern: `EXPERIMANCE_<SECTION>_<KEY>=value`

## Development

Each service is a complete Python package with its own:
- Dependencies in pyproject.toml
- Source code in src/package_name/
- Tests in its own tests/ directory

This structure makes development cleaner by:
- Avoiding complex import hacks
- Supporting proper editable installs
- Making packages independently testable

### Type Stub Automation

To keep type stubs (`schemas.pyi` and `constants.pyi`) up to date for static analysis and IDE support, use the provided script:

```bash
uv run python scripts/update_pyi_stubs.py --diff   # Show diffs and confirm before overwriting
uv run python scripts/update_pyi_stubs.py --dry-run # Preview generated files only
uv run python scripts/update_pyi_stubs.py           # Update files directly
```

This script automatically generates and updates the stub files based on the current base and project-specific schemas/constants. Use the `--diff` or `--dry-run` options for safety before overwriting.


## Multi-Project Architecture

This codebase supports multiple art installation projects through a **dynamic loading system**:

### How It Works
- **Base schemas/constants** in `libs/common/src/experimance_common/*_base.py` define shared functionality
- **Project-specific extensions** in `projects/{project_name}/` override or extend base definitions
- **Dynamic loading** at runtime merges base + project-specific definitions based on `PROJECT_ENV`

### Project Selection
- Set `PROJECT_ENV=experimance` or `PROJECT_ENV=projectname` to switch projects
- Each project can have different enums and message extensions


## Creating a New Project

You can create a new project either manually or using the interactive setup script:

### Option 1: Manual Creation

1. **Create the project directory:**
   - Add a new folder under `projects/{new_project}/`
2. **Add project-specific files:**
   - `.env` for environment variables
   - `config.toml` for project-wide configuration
   - `constants.py` for project-specific constants
   - `schemas.py` for project-specific schemas (extend base classes as needed)
   - `schemas.pyi` for type stubs
   - `<service>.toml` for each service config (e.g., `core.toml`, `display.toml`)
3. **Extend base schemas and enums:**
   - In `schemas.py`, extend base classes (see [libs/common/README_SERVICE.md](libs/common/README_SERVICE.md) for examples)
   - Define project-specific enums and message types
4. **Update static analysis paths:**
   - Add your project directory to `mypy_path` in `pyproject.toml` for type checking
5. **Test your project:**
   - Set `PROJECT_ENV={new_project}` and run services to verify correct loading

### Option 2: Using the Interactive Script

Use the provided script to automate project setup:

```bash
uv run python scripts/create_new_project.py
```

This script will:
- Prompt for project name and services
- Copy config templates from existing projects or service defaults
- Generate all necessary files and directories
- Ensure proper structure for multi-project support

**Features:**
- Supports copying configs from other projects or service defaults
- Generates TOML config, Python templates, and type stubs
- Interactive prompts for customization

See [scripts/README.md](scripts/README.md) for usage details and options.

---

### Schema Extension Pattern
```python
# In projects/{project}/schemas.py
from experimance_common.schemas_base import RenderRequest as _BaseRenderRequest

class RenderRequest(_BaseRenderRequest):
    era: Era              # Project-specific Era enum
    biome: Biome          # Project-specific Biome enum  
    # Add project-specific fields here
```

### Benefits
- **Shared Infrastructure**: All projects use the same ZMQ communication, base services, and utilities
- **Type Safety**: Each project gets proper type checking for its specific Era/Biome values
- **Clean Separation**: Project-specific logic is isolated in `projects/` directory
- **Easy Switching**: Change `PROJECT_ENV` to work on different projects
- **Extensible**: New projects can add custom message types or extend existing ones

### Usage Examples
```bash
# Work on Experimance project
PROJECT_ENV=experimance uv run -m experimance_core

# Work on Sohkepayin project  
PROJECT_ENV=sohkepayin uv run -m experimance_core

# Import project-specific schemas
from experimance_common.schemas import Era, Biome  # Loaded based on PROJECT_ENV
```



### Install tools

```bash
uv tool install ruff
uv tool install pytest
uv add --dev pytest pytest-asyncio pytest-mock pytest-cov 
```

## Package management

Use `uv` and see: https://docs.astral.sh/uv/concepts/projects/workspaces/ for reference.

To update all packages to latest versions:
```
uv sync
```

To update a particular service (e.g. core):
```
uv sync --package experimance-core
```

To update a particular dependency:
```
uv lock --upgrade-package opencv-python
```

### Troubleshooting packages

If you encounter issues with installation or imports, we provide several testing utilities:

```bash
# Basic import test
uv run python utils/tests/simple_test.py

# Check environment setup
uv run python utils/tests/check_env.py
```

See `utils/tests/README.md` for detailed information about these utilities and common troubleshooting steps.


## Testing

Run tests with uv and pytest:

```bash
# Install development dependencies
uv sync --only-dev

# Run all tests
uv run -m pytest

# Run tests with coverage
uv run -m pytest --cov=experimance_common

# Run specific tests
uv run -m pytest -v utils/tests/test_zmq_utils.py -k test_name

# Run tests in a specific service
uv run -m pytest services/audio/tests

# Test agent service vision capabilities
cd services/agent && uv run python tests/test_vision_imports.py
cd services/agent && uv run python tests/test_cpu_detection.py

# Run tests with specific markers or names
uv run -m pytest -k "ImageServer"

```

See [`utils/tests/README.md`](utils/tests/README.md) and [`utils/tests/README_ZMQ_TESTS.md](utils/tests/README_ZMQ_TESTS.md) for more details.

